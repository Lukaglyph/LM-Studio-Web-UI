<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LM Studio Web UI</title>
    <style>
        :root {
            --neon-blue: #00d2ff;
            --neon-purple: #9d50bb;
            --glass-bg: rgba(15, 15, 25, 0.8);
            --border-glow: 0 0 15px rgba(0, 210, 255, 0.3);
            /* デフォルト値 */
            --bot-icon-url: url('https://api.dicebear.com/7.x/bottts/svg?seed=Felix');
            --user-icon-url: url('https://api.dicebear.com/7.x/avataaars/svg?seed=User');
            --card-bg-url: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000&auto=format&fit=crop');
        }

        * { box-sizing: border-box; }
        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: #050508; color: #e0e0e0;
            display: flex; height: 100vh; overflow: hidden;
        }

        /* サイドパネル */
        #side-panel {
            width: 280px; background: rgba(20, 20, 30, 0.95);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px; display: flex; flex-direction: column; gap: 20px; z-index: 10;
        }
        .config-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 11px; color: var(--neon-blue); letter-spacing: 1px; font-weight: bold; }
        input[type="text"] {
            background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff;
            padding: 10px; border-radius: 6px; font-size: 12px; outline: none;
        }
        input[type="text"]:focus { border-color: var(--neon-blue); }

        .btn-secondary {
            background: rgba(255,255,255,0.05); color: #ccc; border: 1px solid #444;
            padding: 8px; border-radius: 4px; cursor: pointer; font-size: 12px;
        }
        .btn-secondary:hover { background: rgba(255,0,0,0.2); color: #ff4444; }

        /* メインエリア */
        #main-layout { flex: 1; display: flex; flex-direction: column; position: relative; }
        #messages {
            flex: 1; overflow-y: auto; padding: 30px;
            display: flex; flex-direction: column; gap: 20px;
        }

        .message-row { display: flex; gap: 15px; animation: slideIn 0.3s ease-out forwards; }
        .user-row { flex-direction: row-reverse; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .avatar {
            width: 45px; height: 45px; border-radius: 12px; background-size: cover;
            border: 2px solid rgba(255,255,255,0.1); flex-shrink: 0;
            background-position: center;
        }

        .bubble {
            max-width: 70%; padding: 15px 20px; border-radius: 18px;
            backdrop-filter: blur(10px); line-height: 1.6;
        }

        .bot-bubble {
            background: var(--glass-bg); border: 1px solid rgba(0, 210, 255, 0.2);
            box-shadow: var(--border-glow);
            background-image: linear-gradient(rgba(15,15,25,0.9), rgba(15,15,25,0.9)), var(--card-bg-url);
            background-size: cover; background-position: center;
        }

        .user-bubble { background: linear-gradient(135deg, var(--neon-purple), #6a11cb); color: white; }

        /* 入力エリア */
        #input-container { padding: 25px; background: rgba(10, 10, 15, 0.9); }
        .input-wrapper {
            max-width: 900px; margin: 0 auto; display: flex; gap: 10px;
            background: rgba(255, 255, 255, 0.05); padding: 5px; border-radius: 15px;
        }
        #user-input { flex: 1; background: transparent; border: none; color: white; padding: 12px 15px; outline: none; }
        #send-btn {
            background: var(--neon-blue); color: #000; border: none;
            padding: 0 25px; border-radius: 12px; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

    <aside id="side-panel">
        <h2 style="font-size: 14px; color: var(--neon-blue);">CONFIGURATION</h2>
        
        <div class="config-group">
            <label>BOT ICON URL</label>
            <input type="text" id="bot-icon-input" placeholder="URL...">
        </div>
        <div class="config-group">
            <label>USER ICON URL</label>
            <input type="text" id="user-icon-input" placeholder="URL...">
        </div>
        <div class="config-group">
            <label>BOT CARD IMAGE</label>
            <input type="text" id="bot-card-input" placeholder="URL...">
        </div>

        <button class="btn-secondary" onclick="clearHistory()">CLEAR HISTORY</button>

        <div style="margin-top: auto; font-size: 10px; color: #555;">STORAGE: LOCAL_DB</div>
    </aside>

    <main id="main-layout">
        <div id="messages"></div>
        <footer id="input-container">
            <div class="input-wrapper">
                <input type="text" id="user-input" placeholder="Send a command..." autocomplete="off">
                <button id="send-btn">SEND</button>
            </div>
        </footer>
    </main>

<script>
    const messagesContainer = document.getElementById('messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    
    // --- ローカルストレージ管理 ---
    const STORAGE_KEY_CHAT = 'cyber_chat_history';
    const STORAGE_KEY_CONFIG = 'cyber_chat_config';

    let chatHistory = JSON.parse(localStorage.getItem(STORAGE_KEY_CHAT)) || [];
    let config = JSON.parse(localStorage.getItem(STORAGE_KEY_CONFIG)) || {
        botIcon: '',
        userIcon: '',
        botCard: ''
    };

    // 初期起動時の読み込み
    window.onload = () => {
        // 設定の反映
        document.getElementById('bot-icon-input').value = config.botIcon;
        document.getElementById('user-icon-input').value = config.userIcon;
        document.getElementById('bot-card-input').value = config.botCard;
        updateStyles();

        // 履歴の描画
        chatHistory.forEach(msg => appendToDOM(msg.role, msg.content));
    };

    // 入力変更時に保存
    ['bot-icon-input', 'user-icon-input', 'bot-card-input'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
            config = {
                botIcon: document.getElementById('bot-icon-input').value,
                userIcon: document.getElementById('user-input-input' === id ? config.userIcon : document.getElementById('user-icon-input').value), // 修正
                userIcon: document.getElementById('user-icon-input').value,
                botCard: document.getElementById('bot-card-input').value
            };
            localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(config));
            updateStyles();
        });
    });

    function updateStyles() {
        const root = document.querySelector(':root');
        if(config.botIcon) root.style.setProperty('--bot-icon-url', `url('${config.botIcon}')`);
        if(config.userIcon) root.style.setProperty('--user-icon-url', `url('${config.userIcon}')`);
        if(config.botCard) root.style.setProperty('--card-bg-url', `url('${config.botCard}')`);
    }

    function appendToDOM(role, text) {
        const row = document.createElement('div');
        row.className = `message-row ${role}-row`;
        row.innerHTML = `
            <div class="avatar" style="background-image: var(--${role}-icon-url)"></div>
            <div class="bubble ${role}-bubble">${text}</div>
        `;
        messagesContainer.appendChild(row);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function saveMessage(role, content) {
        chatHistory.push({ role, content });
        localStorage.setItem(STORAGE_KEY_CHAT, JSON.stringify(chatHistory));
    }

    function clearHistory() {
        if(confirm("会話履歴を消去しますか？")) {
            localStorage.removeItem(STORAGE_KEY_CHAT);
            chatHistory = [];
            messagesContainer.innerHTML = '';
        }
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        appendToDOM('user', text);
        saveMessage('user', text);
        userInput.value = '';
        sendBtn.disabled = true;

        try {
            const response = await fetch("http://localhost:1234/v1/chat/completions", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: chatHistory.slice(-10), // 直近10件の履歴を送信して文脈を維持
                    temperature: 0.7
                })
            });

            const data = await response.json();
            const reply = data.choices[0].message.content;
            
            appendToDOM('bot', reply);
            saveMessage('bot', reply);
        } catch (error) {
            appendToDOM('bot', "ERROR: Server unreachable.");
        } finally {
            sendBtn.disabled = false;
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
</script>

</body>
</html>

